unit PVENTA23;

interface

uses
  Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms, Dialogs,
  ExtCtrls, StdCtrls, Buttons, Mask, DBCtrls, Grids, DBGrids, DB,
  IBCustomDataSet, IBQuery, IBUpdateSQL, DateUtils, ADODB,
  QuerySearchDlgADO, ComCtrls, frxClass, frxDBSet;

type
  TfrmDevolucion = class(TForm)
    Panel5: TPanel;
    Grid: TDBGrid;
    Label16: TLabel;
    Label17: TLabel;
    Label19: TLabel;
    DBEdit7: TDBEdit;
    DBEdit8: TDBEdit;
    DBEdit10: TDBEdit;
    btGrabar: TBitBtn;
    btLimpiar: TBitBtn;
    btClose: TBitBtn;
    QDevolucion: TADOQuery;
    QDevolucionDEV_DESCUENTO: TFloatField;
    QDevolucionDEV_DEVDINERO: TIBStringField;
    QDevolucionDEV_FECHA: TDateTimeField;
    QDevolucionDEV_ITBIS: TFloatField;
    QDevolucionDEV_NUMERO: TIntegerField;
    QDevolucionDEV_STATUS: TIBStringField;
    QDevolucionDEV_TOTAL: TFloatField;
    QDevolucionEMP_CODIGO: TIntegerField;
    QDevolucionFAC_FORMA: TIBStringField;
    QDevolucionFAC_NUMERO: TIntegerField;
    QDevolucionTFA_CODIGO: TIntegerField;
    QDevolucionUSU_CODIGO: TIntegerField;
    QDevolucionVEN_CODIGO: TIntegerField;
    Panel3: TPanel;
    dsDevolucion: TDataSource;
    Search: TQrySearchDlgADO;
    QDevolucionCLI_CODIGO: TIntegerField;
    QDetalle: TADOQuery;
    dsDetalle: TDataSource;
    QDetalleEMP_CODIGO: TIntegerField;
    QDetalleDEV_NUMERO: TIntegerField;
    QDetalleDET_SECUENCIA: TIntegerField;
    QDetallePRO_CODIGO: TIntegerField;
    QDetalleFAM_CODIGO: TIntegerField;
    QDetalleDEV_COSTO: TFloatField;
    QDetalleDEV_PRECIO: TFloatField;
    QDetallePRO_NOMBRE: TIBStringField;
    QDetalleDEV_CANTIDAD: TFloatField;
    QDetalleDEP_CODIGO: TIntegerField;
    QDetalleDEV_TOPECANTIDAD: TFloatField;
    QDetalleDEV_CONITBIS: TIBStringField;
    QDetalleDEV_DESCUENTO: TFloatField;
    QDetalleDEV_ITBIS: TFloatField;
    QDetalleDEV_CANTFACTURADA: TFloatField;
    QDetalleValor: TFloatField;
    QDetalleCalcDesc: TFloatField;
    QDetallePrecioItbis: TFloatField;
    QDetalleCalcItbis: TFloatField;
    QDetalleDevuelta: TFloatField;
    QDetallePRO_RORIGINAL: TIBStringField;
    QDetallePRO_RFABRIC: TIBStringField;
    QDevolucionCAJ_CODIGO: TIntegerField;
    QDevolucionDEV_PORCCOMISION: TFloatField;
    QDevolucionDEV_COMISION: TFloatField;
    rbForma: TRadioGroup;
    QDetallePRO_SERVICIO: TIBStringField;
    QDetalleMAR_CODIGO: TIntegerField;
    QDetalleVEN_CODIGO: TIntegerField;
    QDetalleDET_COMISION: TFloatField;
    QDevolucionDEV_NOMBRE: TIBStringField;
    QDetalleDET_ESCALA: TIBStringField;
    QDetalleDET_MEDIDA: TIBStringField;
    QDetalleNeto: TFloatField;
    QDevolucionBAN_CODIGO: TIntegerField;
    QDevolucionCHE_NUMERO: TIntegerField;
    QDevoluciondev_conitbis: TStringField;
    Label8: TLabel;
    DBLookupComboBox2: TDBLookupComboBox;
    QSucursal: TADOQuery;
    QSucursalsuc_codigo: TIntegerField;
    QSucursalsuc_nombre: TStringField;
    dsSuc: TDataSource;
    QDevolucionsuc_codigo: TIntegerField;
    QDetallesuc_codigo: TIntegerField;
    QSucursalalm_codigo: TIntegerField;
    QSucursalemp_codigo: TIntegerField;
    QDetalledet_lote: TIntegerField;
    QDetalledet_fechavence: TDateTimeField;
    QDetalledet_cant_oferta: TBCDField;
    QDetalledet_selectivo_ad: TBCDField;
    QDetalledet_selectivo_con: TBCDField;
    QDevoluciondev_selectivo_ad: TBCDField;
    QDevoluciondev_selectivo_con: TBCDField;
    Label4: TLabel;
    DBEdit2: TDBEdit;
    Label5: TLabel;
    DBEdit3: TDBEdit;
    Label6: TLabel;
    DBEdit4: TDBEdit;
    QDevolucionSubTotal: TFloatField;
    QDevolucionNCF: TStringField;
    QDevolucionticket_caja: TIntegerField;
    QDevolucionticket_cajero: TIntegerField;
    QDevolucionticket_numero: TIntegerField;
    Label9: TLabel;
    DBEdit5: TDBEdit;
    PageControl1: TPageControl;
    TabSheet1: TTabSheet;
    TabSheet2: TTabSheet;
    Label1: TLabel;
    btTipo: TSpeedButton;
    Label14: TLabel;
    Label3: TLabel;
    Label7: TLabel;
    edTipo: TEdit;
    tTipo: TEdit;
    tPendiente: TEdit;
    DBEdit1: TDBEdit;
    DBEdit6: TDBEdit;
    Label11: TLabel;
    Label15: TLabel;
    Label18: TLabel;
    Label20: TLabel;
    DBEdit9: TDBEdit;
    edCajero: TEdit;
    SpeedButton1: TSpeedButton;
    tusuario: TEdit;
    DBEdit11: TDBEdit;
    DBEdit12: TDBEdit;
    Label12: TLabel;
    Label10: TLabel;
    Label2: TLabel;
    Label13: TLabel;
    tCondicion: TEdit;
    tVendedor: TEdit;
    tCliente: TEdit;
    tCajero: TEdit;
    QDevolucionticket_fecha: TDateTimeField;
    rgtipo: TRadioGroup;
    QDetallealm_codigo: TIntegerField;
    QDevolucionmot_codigo: TIntegerField;
    Label21: TLabel;
    DBEdit13: TDBEdit;
    btmotivo: TSpeedButton;
    tmotivo: TEdit;
    Query1: TADOQuery;
    QDevoluciondev_fecha_factura: TDateTimeField;
    QNorma201806NC: TADOQuery;
    DB_Norma201806NC: TfrxDBDataset;
    Rpt_NC: TfrxReport;
    QNorma201806NCNumero: TStringField;
    QNorma201806NCEmpresaN: TStringField;
    QNorma201806NCEmpresaD: TStringField;
    QNorma201806NCEmpresaL: TStringField;
    QNorma201806NCEmpresaRNC: TStringField;
    QNorma201806NCFECHA: TDateTimeField;
    QNorma201806NCfac_nombre: TStringField;
    QNorma201806NCfac_rnc: TStringField;
    QNorma201806NCfac_direccion: TStringField;
    QNorma201806NCfac_localidad: TStringField;
    QNorma201806NCfac_telefono: TStringField;
    QNorma201806NCNCFModificado: TStringField;
    QNorma201806NCNCF: TStringField;
    QNorma201806NCtip_nombre: TStringField;
    QNorma201806NCCANTIDAD: TStringField;
    QNorma201806NCDESCRIPCION: TStringField;
    QNorma201806NCITBIS: TBCDField;
    QNorma201806NCVALOR: TBCDField;
    QNorma201806NCSUBTOTAL: TBCDField;
    QNorma201806NCusu_nombre: TStringField;
    QNorma201806NCfac_numero: TIntegerField;
    QNorma201806NCDescuento: TFloatField;
    QNorma201806NCITBIS2: TFloatField;
    QUpdDev: TADOQuery;
    QUpdNC: TADOQuery;
    QDetalleDEV_RECARGO: TCurrencyField;
    QDevolucionDEV_RECARGO: TCurrencyField;
    Label22: TLabel;
    dbedtDEV_RECARGO: TDBEdit;
    QDetalleCalcRecargo: TCurrencyField;
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormPaint(Sender: TObject);
    procedure FormKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure ckAEnter(Sender: TObject);
    procedure edTipoKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure btTipoClick(Sender: TObject);
    procedure FormActivate(Sender: TObject);
    procedure QDevolucionNewRecord(DataSet: TDataSet);
    procedure QDevolucionFAC_NUMEROChange(Sender: TField);
    procedure GridEnter(Sender: TObject);
    procedure GridColEnter(Sender: TObject);
    procedure GridKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure btCloseClick(Sender: TObject);
    procedure QDetalleBeforePost(DataSet: TDataSet);
    procedure QDetalleAfterInsert(DataSet: TDataSet);
    procedure QDetalleCalcFields(DataSet: TDataSet);
    procedure QDetalleAfterPost(DataSet: TDataSet);
    procedure btGrabarClick(Sender: TObject);
    procedure QDevolucionBeforePost(DataSet: TDataSet);
    procedure btLimpiarClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure rbFormaClick(Sender: TObject);
    procedure SpeedButton1Click(Sender: TObject);
    procedure edCajeroChange(Sender: TObject);
    procedure edCajeroKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure QDevolucionticket_cajaChange(Sender: TField);
    procedure QDevolucionticket_cajeroChange(Sender: TField);
    procedure QDevolucionticket_numeroChange(Sender: TField);
    procedure QDevolucionticket_fechaChange(Sender: TField);
    procedure rgtipoClick(Sender: TObject);
    procedure btmotivoClick(Sender: TObject);
    procedure QDevolucionmot_codigoGetText(Sender: TField;
      var Text: String; DisplayText: Boolean);
  private
    { Private declarations }
  public
    { Public declarations }
    SelCajero, SelCondi, Totaliza, ActBalance, Insertar, ConItbis : boolean;
    descuento, total, Itbis, recargo, Pendiente, Anterior, Comision, MontoDesem : double;
    FormatoImp, almacen, cajero : integer;
    PuertoImp : string;
    procedure totalizar;
    procedure Imp40Columnas;
    procedure BuscaTicket;
  end;

var
  frmDevolucion: TfrmDevolucion;

implementation

uses RVENTA03, PVENTA37, PVENTA97, SIGMA01, SIGMA00, PVENTA123, RVENTA72,
  StrUtils;

{$R *.DFM}

procedure TfrmDevolucion.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  if SelCajero = true then
  begin
    if messagedlg('SALIR DE ESTA PANTALLA?',
    mtconfirmation, [mbyes,mbno],0) = mrno then
      abort
    else
      action := cafree;
  end
  else
    action := cafree;
end;

procedure TfrmDevolucion.FormPaint(Sender: TObject);
begin
  frmDevolucion.top := 2;
  frmDevolucion.left := 2;
end;

procedure TfrmDevolucion.FormKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if key = vk_f10 then close;
  if key = vk_f2  then btGrabarClick(self);
  if key = vk_f3  then btLimpiarClick(self); 
end;

procedure TfrmDevolucion.FormKeyPress(Sender: TObject; var Key: Char);
begin
  if key = chr(vk_return) then
  begin
    if ActiveControl.classtype <> tdbgrid then
    begin
      perform(wm_nextdlgctl, 0, 0);
      key := #0;
    end;
  end;
end;

procedure TfrmDevolucion.ckAEnter(Sender: TObject);
begin
  edTipo.setfocus;
end;

procedure TfrmDevolucion.edTipoKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if key = vk_return then
  begin
    dm.Query1.close;
    dm.Query1.sql.clear;
    dm.Query1.sql.add('select tfa_nombre, tfa_selcondi');
    dm.Query1.sql.add('from tiposfactura');
    dm.Query1.sql.add('where emp_codigo = :emp');
    dm.Query1.sql.add('and tfa_codigo = :cod');
    dm.Query1.Parameters.parambyname('emp').Value := dm.QEmpresasEMP_CODIGO.value;
    dm.Query1.Parameters.parambyname('cod').Value := strtoint(trim(edTipo.text));
    dm.Query1.open;
    if dm.Query1.recordcount = 0 then
    begin
      tTipo.text := '';
      showmessage('ESTE TIPO DE FACTURA NO EXISTE');
      edTipo.setfocus;
    end
    else
    begin
      QDevolucion.close;
      QDevolucion.Parameters.parambyname('numero').Value := -1;
      QDevolucion.open;
      QDevolucion.insert;

//      PuertoImp  := dm.Query1.fieldbyname('tfa_puertoimp').asstring;
      tTipo.text := dm.Query1.fieldbyname('tfa_nombre').asstring;
      SelCondi   := dm.Query1.FieldByName('tfa_selcondi').AsBoolean;
    end;
  end;
end;

procedure TfrmDevolucion.btTipoClick(Sender: TObject);
begin
  search.Query.clear;
  search.AliasFields.clear;
  search.Query.add('select tfa_nombre, tfa_codigo');
  search.Query.add('from tiposfactura');
  search.Query.add('where emp_codigo = '+inttostr(dm.QEmpresasEMP_CODIGO.value));
  search.AliasFields.add('Nombre');
  search.AliasFields.add('Código');
  search.ResultField := 'tfa_codigo';
  search.Title := 'Tipos de factura';
  if search.execute then
  begin
    edTipo.text := search.valuefield;
    dm.Query1.close;
    dm.Query1.sql.clear;
    dm.Query1.sql.add('select tfa_nombre, tfa_selcondi, tfa_formatoimp, tfa_puertoimp');
    dm.Query1.sql.add('from tiposfactura');
    dm.Query1.sql.add('where emp_codigo = :emp');
    dm.Query1.sql.add('and tfa_codigo = :cod');
    dm.Query1.Parameters.parambyname('emp').Value := dm.QEmpresasEMP_CODIGO.value;
    dm.Query1.Parameters.parambyname('cod').Value := strtoint(trim(edTipo.text));
    dm.Query1.open;

    QDevolucion.close;
    QDevolucion.Parameters.parambyname('numero').Value := -1;
    QDevolucion.Parameters.parambyname('suc').Value := -1;
    QDevolucion.open;
    QDevolucion.insert;

    //PuertoImp  := dm.Query1.fieldbyname('tfa_puertoimp').asstring;
    //FormatoImp := dm.Query1.fieldbyname('tfa_formatoImp').asinteger;
    tTipo.text := dm.Query1.fieldbyname('tfa_nombre').asstring;
    edTipo.SetFocus;
    SelCondi := dm.Query1.FieldByName('tfa_selcondi').AsBoolean;
    SelectNext(activecontrol, true, true);
  end;
end;

procedure TfrmDevolucion.FormActivate(Sender: TObject);
begin
  if SelCajero = False then
  begin
    Application.CreateForm(tfrmPideCajero, frmPideCajero);
    if frmPideCajero.ShowModal <> mrOk then
    begin
      frmPideCajero.release;
      close;
    end
    else
    begin
      SelCajero := True;
      Cajero := dm.Query1.fieldbyname('caj_codigo').asinteger;
      frmPideCajero.release;
    end;
    if not QDevolucion.active then
    begin
      QSucursal.Parameters.ParamByName('usu').Value := dm.Usuario;
      QSucursal.Open;

      rbForma.ItemIndex := 0;
      QDevolucion.Parameters.parambyname('numero').Value := -1;
      QDevolucion.Parameters.parambyname('suc').Value := -1;
      QDevolucion.open;
      QDevolucion.insert;
    end;
  end;
end;

procedure TfrmDevolucion.QDevolucionNewRecord(DataSet: TDataSet);
begin
   tPendiente.text := '';
  Insertar := True;
  Totaliza := True;

  rgtipo.ItemIndex := 0;
  QDevolucionDEV_DEVDINERO.value := 'N';
  QDevolucionsuc_codigo.Value := QSucursalsuc_codigo.Value;
  QdevolucionFAC_FORMA.Value  := rbForma.Items[rbForma.ItemIndex];
  QDevolucionDEV_FECHA.value  := date;
  QDevolucionDEV_STATUS.value := 'EMI';
  QDevolucionDEV_TOTAL.value  := 0;
  QDevolucionDEV_ITBIS.value  := 0;
  QDevolucionDEV_DESCUENTO.value := 0;
  QDevolucionUSU_CODIGO.value := dm.Usuario;
  QDevolucionEMP_CODIGO.value := dm.QEmpresasEMP_CODIGO.value;
  tCondicion.text := '';
  tVendedor.text := '';
  tTipo.text := '';
  tCliente.text := '';
  tCajero.text := '';
  QDetalle.close;
  QDetalle.Parameters.parambyname('emp').Value := dm.QEmpresasEMP_CODIGO.value;
  QDetalle.Parameters.parambyname('numero').Value := -1;
  QDetalle.Parameters.parambyname('suc').Value := -1;
  QDetalle.open;
end;

procedure TfrmDevolucion.QDevolucionFAC_NUMEROChange(Sender: TField);
var
  Condi, Cajero, a : integer;
begin
  if rgtipo.ItemIndex = 0 then
  if tTipo.text='' then
     MessageDlg('DEBE ELEJIR UN TIPO DE FACTURA',mtError,[mbok],0)
  else
  begin
    if not QDevolucionFAC_NUMERO.isnull then
    begin
      dm.Query1.close;
      dm.Query1.sql.clear;
      dm.Query1.sql.add('select f.fac_nombre, f.ven_codigo, f.cpa_codigo, f.cli_codigo,');
      dm.Query1.sql.add('f.alm_codigo, f.fac_status, f.fac_total, f.fac_abono, f.alm_codigo,');
      dm.Query1.sql.add('f.caj_codigo, t.tfa_actbalance, f.fac_porccomision, f.fac_fecha,');
      dm.Query1.sql.add('f.fac_cuotas, f.fac_conitbis, f.ncf_fijo, f.ncf_secuencia, recargo');
      dm.Query1.sql.add('from facturas f, tiposfactura t');
      dm.Query1.sql.add('where f.emp_codigo = t.emp_codigo');
      dm.Query1.sql.add('and f.tfa_codigo = t.tfa_Codigo');
      dm.Query1.sql.add('and f.emp_codigo = :emp');
      dm.Query1.sql.add('and f.fac_forma    = :forma');
      dm.Query1.sql.add('and f.tfa_codigo   = :tipo');
      dm.Query1.sql.add('and f.fac_numero   = :numero');
      dm.Query1.sql.add('and f.suc_codigo = :suc');
      dm.Query1.Parameters.parambyname('emp').Value    := dm.QEmpresasEMP_CODIGO.value;
      dm.Query1.Parameters.parambyname('forma').Value  := QDevolucionFAC_FORMA.Value;
      dm.Query1.Parameters.parambyname('tipo').Value   := strtoint(trim(edTipo.text));
      dm.Query1.Parameters.parambyname('numero').Value := QDevolucionFAC_NUMERO.value;
      dm.Query1.Parameters.parambyname('suc').Value    := QDevolucionsuc_codigo.Value;
      dm.Query1.open;
      if dm.Query1.recordcount = 0 then
      begin
        showmessage('ESTA FACTURA NO EXISTE');
        QDevolucionFAC_NUMERO.Clear;
        abort;
      end
      else if dm.Query1.fieldbyname('fac_cuotas').AsInteger > 0 then
      begin
        showmessage('NO PUEDE REALIZARSE DEVOLUCION A FACTURAS QUE'+#13+
                    'TIENEN FIANANCIAMIENTO, DEBE DE REALIZAR UNA'+#13+
                    'NOTA DE CREDITO');
        QDevolucionFAC_NUMERO.Clear;
        abort;
      end
      else if dm.Query1.fieldbyname('fac_status').asstring = 'ANU' then
      begin
        showmessage('ESTA FACTURA ESTA ANULADA');
        QDevolucionFAC_NUMERO.Clear;
        abort;
      end
      else if DaysBetween(dm.Query1.fieldbyname('fac_fecha').AsDateTime, Date) >
      dm.QParametrosPAR_DEVDIAS.Value then
      begin
        MessageDlg('ESTA FACTURA NO ACEPTA DEVOLUCIONES',mtError,[mbok],0);
        QDevolucionFAC_NUMERO.Clear;
        abort;
      end
      else
      begin
        ConItbis  := dm.Query1.fieldbyname('fac_conitbis').asboolean;
        QDevolucionDEV_CONITBIS.Value := dm.Query1.fieldbyname('fac_conitbis').Value;
        Pendiente := dm.Query1.fieldbyname('fac_total').asfloat-dm.Query1.fieldbyname('fac_abono').asfloat;
        Condi     := dm.Query1.fieldbyname('cpa_codigo').asinteger;
        Cajero    := dm.Query1.fieldbyname('caj_codigo').asinteger;
        tCliente.text := dm.Query1.fieldbyname('fac_nombre').asstring;
        QdevolucionDEV_NOMBRE.Value := dm.Query1.fieldbyname('fac_nombre').asstring;
        QDevoluciondev_fecha_factura.Value := dm.Query1.fieldbyname('fac_fecha').Value;
        QDevolucionCLI_CODIGO.value := dm.Query1.fieldbyname('cli_codigo').asinteger;
        QDevolucionVEN_CODIGO.value := dm.Query1.fieldbyname('ven_codigo').asinteger;
        QDevolucionNCF.Value        := dm.Query1.fieldbyname('ncf_fijo').AsString +
                                       FormatFloat('00000000',dm.Query1.fieldbyname('ncf_secuencia').AsFloat);
        ACTBalance := dm.Query1.fieldbyname('tfa_actbalance').asboolean;
        tPendiente.text := format('%n',[Pendiente]);
        QDevolucionDEV_RECARGO.value := dm.Query1.fieldbyname('recargo').asinteger;


        //buscando vendedor
        dm.Query1.close;
        dm.Query1.sql.clear;
        dm.Query1.sql.add('select ven_nombre from vendedores');
        dm.Query1.sql.add('where ven_codigo = :ven');
        dm.Query1.sql.add('and emp_codigo = :emp');
        dm.Query1.Parameters.parambyname('emp').Value := dm.QEmpresasEMP_CODIGO.value;
        dm.Query1.Parameters.parambyname('ven').Value := QDevolucionVEN_CODIGO.value;
        dm.Query1.open;
        tVendedor.text := dm.Query1.fieldbyname('ven_nombre').asstring;

        //buscando condiciones
        dm.Query1.close;
        dm.Query1.sql.clear;
        dm.Query1.sql.add('select cpa_nombre from condiciones');
        dm.Query1.sql.add('where cpa_codigo = :cod');
        dm.Query1.sql.add('and emp_codigo = :emp');
        dm.Query1.Parameters.parambyname('emp').Value := dm.QEmpresasEMP_CODIGO.value;
        dm.Query1.Parameters.parambyname('cod').Value := Condi;
        dm.Query1.open;
        tCondicion.text := dm.Query1.fieldbyname('cpa_nombre').asstring;

        //buscando cajero
        dm.Query1.close;
        dm.Query1.sql.clear;
        dm.Query1.sql.add('select caj_nombre from cajeros');
        dm.Query1.sql.add('where caj_codigo = :cod');
        dm.Query1.sql.add('and emp_codigo = :emp');
        dm.Query1.Parameters.parambyname('emp').Value := dm.QEmpresasEMP_CODIGO.value;
        dm.Query1.Parameters.parambyname('cod').Value := Cajero;
        dm.Query1.open;
        tCajero.text := dm.Query1.fieldbyname('caj_nombre').asstring;

        //Buscando detalle de la factura
        dm.Query1.close;
        dm.Query1.sql.clear;
        dm.Query1.sql.add('select pro_codigo, pro_nombre, det_costo, det_precio, det_total,');
        dm.Query1.sql.add('det_cantidad, det_conitbis, det_itbis, det_descuento, pro_servicio,');
        dm.Query1.sql.add('det_cantdevuelta, pro_roriginal, pro_rfabric, det_comision,');
        dm.Query1.sql.add('ven_codigo, det_escala, det_medida, det_lote, det_fechavence,');
        dm.Query1.sql.add('isnull(det_cant_oferta,0) as det_cant_oferta,');
        dm.Query1.sql.add('det_selectivo_ad, det_selectivo_con, alm_codigo, ((det_precio*det_cantidad)*Recargo) recargo ');
        dm.Query1.sql.add('from det_factura');
        dm.Query1.sql.add('where emp_codigo = :emp');
        dm.Query1.sql.add('and fac_forma    = :forma');
        dm.Query1.sql.add('and tfa_codigo   = :tipo');
        dm.Query1.sql.add('and fac_numero   = :numero');
        dm.Query1.sql.add('and suc_codigo   = :suc');
        dm.Query1.Parameters.parambyname('emp').Value    := dm.QEmpresasEMP_CODIGO.value;
        dm.Query1.Parameters.parambyname('forma').Value  := QDevolucionFAC_FORMA.Value;
        dm.Query1.Parameters.parambyname('tipo').Value   := strtoint(trim(edTipo.text));
        dm.Query1.Parameters.parambyname('numero').Value := QDevolucionFAC_NUMERO.value;
        dm.Query1.Parameters.parambyname('suc').Value    := QDevolucionsuc_codigo.Value;
        dm.Query1.open;
        dm.Query1.disablecontrols;

        QDetalle.close;
        QDetalle.open;
        a := 0;
        Insertar := True;
        while not dm.Query1.eof do
        begin
          a := a + 1;
          QDetalle.append;
          QDetalleDET_SECUENCIA.value     := a;
          QDetalleDET_ESCALA.Value        := dm.Query1.fieldbyname('det_escala').AsString;
          QDetalleVEN_CODIGO.Value        := dm.Query1.fieldbyname('ven_codigo').AsInteger;
          QDetalleDET_COMISION.Value      := dm.Query1.fieldbyname('det_comision').AsFloat;
          QDetallePRO_SERVICIO.Value      := dm.Query1.fieldbyname('pro_servicio').AsString;
          QDetalleEMP_CODIGO.value        := dm.QEmpresasEMP_CODIGO.value;
          QDetallePRO_CODIGO.value        := dm.Query1.fieldbyname('pro_codigo').asinteger;
          QDetalleDEV_COSTO.value         := dm.Query1.fieldbyname('det_costo').asfloat;
          QDetalleDEV_PRECIO.value        := dm.Query1.fieldbyname('det_precio').AsFloat;
          QDetalleDEV_TOPECANTIDAD.value  := dm.Query1.fieldbyname('det_cantidad').asfloat-
                                            dm.Query1.fieldbyname('det_cantdevuelta').asfloat;
          QDetalleDEV_CONITBIS.value      := dm.Query1.fieldbyname('det_conitbis').asstring;
          QDetalleDEV_DESCUENTO.value     := dm.Query1.fieldbyname('det_descuento').asfloat;
          QDetalleDEV_ITBIS.value         := dm.Query1.fieldbyname('det_itbis').asfloat;
          QDetalleDEV_CANTFACTURADA.value := dm.Query1.fieldbyname('det_cantidad').asfloat;
          QDetallePRO_NOMBRE.value        := dm.Query1.fieldbyname('pro_nombre').asstring;
          QDetallePRO_RORIGINAL.value     := dm.Query1.fieldbyname('pro_roriginal').asstring;
          QDetallePRO_RFABRIC.value       := dm.Query1.fieldbyname('pro_rfabric').asstring;
          QDetalleDET_MEDIDA.Value        := dm.Query1.fieldbyname('det_medida').asstring;
          QDetalledet_lote.Value          := dm.Query1.fieldbyname('det_lote').AsInteger;
          QDetalledet_fechavence.Value    := dm.Query1.fieldbyname('det_fechavence').AsDateTime;
          QDetalledet_cant_oferta.Value   := dm.Query1.fieldbyname('det_cant_oferta').asfloat;
          QDetalledet_selectivo_ad.Value  := dm.Query1.fieldbyname('det_selectivo_ad').asfloat;
          QDetalledet_selectivo_con.Value := dm.Query1.fieldbyname('det_selectivo_con').asfloat;
          QDetallealm_codigo.Value        := dm.Query1.fieldbyname('alm_codigo').AsInteger;
          QDetalleDEV_RECARGO.Value       := dm.Query1.fieldbyname('recargo').asfloat;
          QDetalle.post;
          dm.Query1.next;
        end;
        dm.Query1.enablecontrols;
        QDetalle.first;
        Insertar := False;
      end;
    end;
  end;
  QDevolucionSubTotal.Value :=  0;
  QDevolucionDEV_TOTAL.Value := 0;
end;

procedure TfrmDevolucion.GridEnter(Sender: TObject);
begin
  Grid.SelectedIndex := Grid.Columns.Count -2;
end;

procedure TfrmDevolucion.GridColEnter(Sender: TObject);
begin
  if uppercase(Grid.Columns[Grid.selectedindex].FieldName) <> 'DEV_CANTIDAD' then
    Grid.SelectedIndex := Grid.Columns.Count -2;
end;

procedure TfrmDevolucion.GridKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if key = vk_return then
  begin
    QDetalle.edit;
    QDetalle.post;
  end;
end;

procedure TfrmDevolucion.btCloseClick(Sender: TObject);
begin
  close;
end;

procedure TfrmDevolucion.QDetalleBeforePost(DataSet: TDataSet);
begin
  if format('%10.2f',[QDetalleDEV_CANTIDAD.value]) > format('%10.2f',[QDetalleDEV_TOPECANTIDAD.value]) then
  begin
    showmessage('CANTIDAD A DEVOLVER NO PUEDE SER MAYOR A LA'+#13+
                'CANTIDAD RESTANTE DEL PRODUCTO DE ESTA FACTURA');
    QDetalleDEV_CANTIDAD.clear;
    abort;
  end;


end;

procedure TfrmDevolucion.QDetalleAfterInsert(DataSet: TDataSet);
begin
  if Insertar = false then QDetalle.cancel;
end;

procedure TfrmDevolucion.totalizar;
var
  punt : tbookmark;
  SelectivoAd, SelectivoCon, vl_recargo, vl_subtotal: Double;
begin
  total := 0;
  Itbis := 0;
  Descuento := 0;
  vl_recargo := 0;
  vl_subtotal := 0;
  punt := QDetalle.GetBookmark;
  SelectivoAd := 0;
  SelectivoCon := 0;
  QDetalle.disablecontrols;
  QDetalle.first;
  while not QDetalle.eof do
  begin
    vl_recargo := QDetalleDEV_RECARGO.Value;
    Descuento := Descuento  + QDetalleCalcDesc.value;
    Itbis     := Itbis + QDetalleCalcItbis.value;
    if (ConItbis) and (dm.QParametrospar_itbisincluido.Value = 'True') then
    total  := total + QDetalleValor.Value
    else
    Total  := Total  + QDetalleValor.Value+
                        vl_recargo;
    SelectivoAd  := SelectivoAd  + (QDetalledet_selectivo_ad.Value);
    SelectivoCon := SelectivoCon + (QDetalledet_selectivo_con.Value);
    vl_subtotal  := total-vl_recargo-Itbis;
    QDetalle.next;
  end;
  QDetalle.GotoBookmark(punt);
  QDetalle.enablecontrols;
  QDevolucionSubTotal.value     :=  vl_subtotal;
  QDevolucionDEV_ITBIS.value     := Itbis;
  QDevolucionDEV_DESCUENTO.value := Descuento;
  QDevoluciondev_selectivo_ad.Value  := SelectivoAd;
  QDevoluciondev_selectivo_con.Value := SelectivoCon;
  QDevolucionDEV_TOTAL.value         := (vl_subtotal+Itbis+vl_recargo+SelectivoAd+SelectivoCon)-Descuento;
  QDevolucionDEV_RECARGO.Value       := vl_recargo;
end;

procedure TfrmDevolucion.QDetalleCalcFields(DataSet: TDataSet);
var
  Venta, NumItbis : Double;
begin
  if QDetalleDEV_CONITBIS.value = 'S' then
  begin
    NumItbis := strtofloat(format('%10.2f',[(QDetalleDEV_ITBIS.asfloat/100)+1]));
    if dm.QParametrospar_itbisincluido.Value = 'True' then
    begin
      recargo  := QDetalleDEV_RECARGO.Value;
      Venta    := recargo+((QDetalleDEV_PRECIO.value*QDetalleDEV_CANTIDAD.value)/NumItbis);
      QDetallePrecioItbis.value := Venta;
      QDetalleCalcRecargo.Value := recargo;
      QDetalleCalcDesc.value    := (Venta * QDetalleDEV_DESCUENTO.value)/100;
      QDetalleCalcItbis.value   := ((venta-QDetalleCalcDesc.Value)*(NumItbis-1));
      QDetalleValor.value       := ((Venta)+QDetalledet_selectivo_ad.Value+
                                   QDetalledet_selectivo_con.Value+QDetalleCalcItbis.value);
    end
    else
    begin
      recargo  := QDetalleDEV_RECARGO.Value;
      Venta    := (QDetalleDEV_CANTIDAD.value*QDetalleDEV_PRECIO.value)+recargo;
      QDetallePrecioItbis.value := QDetalleDEV_PRECIO.value+QDetalledet_selectivo_ad.Value+QDetalledet_selectivo_con.Value;
      QDetalleCalcRecargo.Value := recargo;
      QDetalleCalcDesc.value    := (Venta *QDetalleDEV_DESCUENTO.value)/100;
      if ConItbis then
        QDetalleCalcItbis.value := ((((Venta-QDetalleCalcDesc.Value)+(QDetalledet_selectivo_ad.Value+QDetalledet_selectivo_con.Value))*
                                       QDetalleDEV_ITBIS.Value)/100)
      else
        QDetalleCalcItbis.value := 0;

      QDetalleValor.value       := QDetalleDEV_CANTIDAD.Value*(((Venta-QDetalleCalcDesc.value)+QDetalledet_selectivo_ad.Value+
                                   QDetalledet_selectivo_con.Value+QDetalleCalcItbis.value));
    end;
  end
  else
  begin
    recargo  := QDetalleDEV_RECARGO.Value;
    Venta := QDetalleDEV_CANTIDAD.Value*(QDetalleDEV_PRECIO.value+recargo);
    QDetalleCalcDesc.value    := (Venta * QDetalleDEV_DESCUENTO.value)/100;
    QDetallePrecioItbis.value := Venta;
    QDetalleCalcItbis.value   := Itbis ;
    QDetalleCalcRecargo.Value := recargo;
    QDetalleValor.value       := (Venta-QDetalleCalcDesc.value);
  end;
  QDetalleNeto.Value := (QDetalleValor.Value - QDetalleCalcDesc.Value)+QDetalleCalcItbis.Value;
  QDetalleDevuelta.Value := QDetalleDEV_CANTFACTURADA.Value - QDetalleDEV_TOPECANTIDAD.Value;


end;

procedure TfrmDevolucion.QDetalleAfterPost(DataSet: TDataSet);
begin
  if Totaliza = true then Totalizar;
end;

procedure TfrmDevolucion.btGrabarClick(Sender: TObject);
var
  desem : integer;
  devdinero : string;
begin
  //verificando si el cierre se hizo para esta fecha
  dm.Query1.Close;
  dm.Query1.SQL.Clear;
  dm.Query1.SQL.Add('select cie_fecha from cierre');
  dm.Query1.SQL.Add('where emp_codigo = :emp');
  dm.Query1.SQL.Add('and cie_fecha = :fec');
  dm.Query1.Parameters.ParamByName('emp').Value := dm.QEmpresasEMP_CODIGO.Value;
  dm.Query1.Parameters.ParamByName('fec').Value    := QDevolucionDEV_FECHA.Value;
  dm.Query1.Open;
  if dm.Query1.RecordCount > 0 then
  begin
    MessageDlg('LA DEVOLUCION NO PUEDE REALIZARSE, DEBIDO A QUE ESTE'+#13+
               'DIA FUE CERRADO.',mtError,[mbok],0);
    Grid.setfocus;
  end
  else if Total <= 0 then
  begin
    showmessage('LA DEVOLUCION NO ESTA COMPLETADA');
    Grid.setfocus;
    abort;
  end
  else
  begin
    if messagedlg('TODOS LOS DATOS ESTAN CORRECTOS?',mtconfirmation,[mbyes,mbno],0) = mryes then
    begin
      if not dm.QParametrospar_almacendevolucion.IsNull then
        almacen := dm.QParametrospar_almacendevolucion.Value
      else
        begin   //si el codigo almacen esa vacio busca el codigo del alamcen de la sucursal ///TITIN
          if (almacen = 0) and (not QSucursalalm_codigo.IsNull) then
            almacen:= QSucursalalm_codigo.Value
          else almacen := 1;
        end;


      if rgtipo.ItemIndex = 0 then
      begin
        if ActBalance = false then
        begin
          if dm.QParametrosPAR_DEVEFECTIVO.Value = 'True' then
          begin
            if messagedlg('DESEA DEVOLVER EL EFECTIVO A ESTE CLIENTE?', mtconfirmation, [mbyes,mbno], 0) = mryes then
            begin
              devdinero := 'S';
              if dm.QParametrosPAR_DEVFORMA.Value = 'E' then
              begin
                Application.CreateForm(tfrmDevDinero, frmDevDinero);
                frmDevDinero.Ins := True;
                frmDevDinero.QFormasPago.Open;
                frmDevDinero.QForma.Open;
                frmDevDinero.QFormasPago.Edit;
                frmDevDinero.QFormasPagoEMP_CODIGO.Value := dm.QEmpresasEMP_CODIGO.Value;
                frmDevDinero.QFormasPagoFPA_CODIGO.Value := dm.QParametrosPAR_FPADESEM.Value;
                frmDevDinero.QFormasPagoFOR_MONTO.Value  := QDevolucionDEV_TOTAL.Value;
                frmDevDinero.QFormasPagosuc_codigo.Value := QDevolucionsuc_codigo.Value;
                frmDevDinero.QFormasPago.Post;
                frmDevDinero.Ins := False;
              end
              else if dm.QParametrosPAR_DEVFORMA.Value = 'C' then
              begin
                Application.CreateForm(tfrmChequeDevol, frmChequeDevol);
                frmChequeDevol.ShowModal;
              end;
            end
            else
              devdinero := 'N';
          end
          else
              devdinero := 'N';
          QDevolucionDEV_DEVDINERO.Value := devdinero;
        end;
        if (devdinero = 'N') and (QDevolucionCLI_CODIGO.Value = 0) then
        begin
          messagedlg('ESTA DEVOLUCION SE REALIZO A UNA FACTURA'+#13+
                     'DE UN CLIENTE QUE NO PERTENECE AL SISTEMA,'+#13+
                     'POR LO TANTO NO SE PUEDE CREAR LA NOTA DE'+#13+
                     'CREDITO.',mtwarning,[mbok],0);
          Grid.SetFocus;
        end
        else
        begin

            QDevolucionTFA_CODIGO.value := strtoint(trim(edTipo.text));

          QDevolucion.Post;
          QDevolucion.UpdateBatch;

          Totaliza := False;

          //grabando detalle
          QDetalle.disablecontrols;
          QDetalle.first;
          while not QDetalle.eof do
          begin
            QDetalle.edit;
            QDetalleDEV_NUMERO.value    := QDevolucionDEV_NUMERO.value;
            QDetallesuc_codigo.Value    := QDevolucionsuc_codigo.Value;
            QDetalle.post;
            QDetalle.next;
          end;
          QDetalle.enablecontrols;
          QDetalle.UpdateBatch;

          dm.Query1.close;
          dm.Query1.sql.clear;
          dm.Query1.sql.add('execute pr_graba_dev :emp, :suc, :num, :act, :alm');
          dm.Query1.Parameters.parambyname('emp').Value := dm.QEmpresasEMP_CODIGO.value;
          dm.Query1.Parameters.parambyname('num').Value := QDevolucionDEV_NUMERO.value;
          dm.Query1.Parameters.parambyname('suc').Value := QDevolucionsuc_codigo.value;

          if ACTBalance = True then
             dm.Query1.Parameters.parambyname('act').Value := 'True'
          else
             dm.Query1.Parameters.parambyname('act').Value := 'False';
          dm.Query1.Parameters.parambyname('alm').Value := almacen;
          dm.Query1.ExecSQL;

          if ActBalance = false then
          begin
            if devdinero = 'S' then
            begin
              if dm.QParametrosPAR_DEVFORMA.Value = 'E' then
              begin
                dm.Query1.close;
                dm.Query1.sql.clear;
                dm.Query1.sql.add('execute pr_devolucion_rec');
                dm.Query1.sql.add(':emp, :suc, :dev, :usu, :caj, '+#39+'S'+#39);
                dm.Query1.Parameters.parambyname('emp').Value := dm.QEmpresasEMP_CODIGO.value;
                dm.Query1.Parameters.parambyname('dev').Value := QDevolucionDEV_NUMERO.value;
                dm.Query1.Parameters.parambyname('usu').Value := dm.Usuario;
                dm.Query1.Parameters.parambyname('caj').Value := Cajero;
                dm.Query1.Parameters.parambyname('suc').Value := QDevolucionsuc_codigo.value;
                dm.Query1.ExecSQL;

                dm.Query1.close;
                dm.Query1.sql.clear;
                dm.Query1.sql.add('select des_numero from desembolsos');
                dm.Query1.sql.add('where emp_codigo = :emp');
                dm.Query1.sql.add('and dev_numero = :num');
                dm.Query1.sql.add('and suc_codigo = :suc');
                dm.Query1.Parameters.parambyname('emp').Value := dm.QEmpresasEMP_CODIGO.value;
                dm.Query1.Parameters.parambyname('num').Value := QDevolucionDEV_NUMERO.value;
                dm.Query1.Parameters.parambyname('suc').Value := QDevolucionsuc_codigo.value;
                dm.Query1.Open;

                frmDevDinero.Totaliza := false;
                frmDevDinero.QFormasPago.DisableControls;
                frmDevDinero.QFormasPago.First;
                while not frmDevDinero.QFormasPago.eof do
                begin
                  frmDevDinero.QFormasPago.Edit;
                  frmDevDinero.QFormasPagoEMP_CODIGO.Value := dm.QEmpresasEMP_CODIGO.Value;
                  frmDevDinero.QFormasPagoDES_NUMERO.Value := dm.Query1.FieldByName('des_numero').AsInteger;
                  frmDevDinero.QFormasPagosuc_codigo.Value := QDevolucionsuc_codigo.Value;
                  frmDevDinero.QFormasPago.Post;
                  frmDevDinero.QFormasPago.next;
                end;
                frmDevDinero.Totaliza := true;
                frmDevDinero.QFormasPago.EnableControls;
                frmDevDinero.QFormasPago.UpdateBatch;
                frmDevDinero.Release;

              end
              else
              begin
                frmChequeDevol.QCheques.UpdateBatch;
                frmChequeDevol.QDetalle.UpdateBatch;

                dm.Query1.close;
                dm.Query1.sql.clear;
                dm.Query1.sql.add('execute pr_devolucion_ck');
                dm.Query1.sql.add(':emp, :suc, :dev, :ban, :che, :sol');
                dm.Query1.Parameters.parambyname('emp').Value := dm.QEmpresasEMP_CODIGO.value;
                dm.Query1.Parameters.parambyname('dev').Value := QDevolucionDEV_NUMERO.value;
                dm.Query1.Parameters.parambyname('ban').Value := frmChequeDevol.QChequesBAN_CODIGO.Value;
                dm.Query1.Parameters.parambyname('che').Value := frmChequeDevol.QChequesCHE_NUMERO.Value;
                dm.Query1.Parameters.parambyname('sol').Value  := trim(frmChequeDevol.edSol.Text);
                dm.Query1.Parameters.parambyname('suc').Value := QDevolucionsuc_codigo.value;
                dm.Query1.ExecSQL;
                frmChequeDevol.Release;
              end;
            end
            else
            begin
              if QDevolucionCLI_CODIGO.value = 0 then
                messagedlg('ESTA DEVOLUCION SE REALIZO A UNA FACTURA'+#13+
                           'DE UN CLIENTE QUE NO PERTENECE AL SISTEMA,'+#13+
                           'POR LO TANTO NO SE PUEDE CREAR LA NOTA DE'+#13+
                           'CREDITO.',mtwarning,[mbok],0)
              else
              begin
                dm.Query1.close;
                dm.Query1.sql.clear;
                dm.Query1.sql.add('execute pr_devolucion_rec');
                dm.Query1.sql.add(':emp, :suc, :dev, :usu, :caj, '+#39+'N'+#39);
                dm.Query1.Parameters.parambyname('emp').Value := dm.QEmpresasEMP_CODIGO.value;
                dm.Query1.Parameters.parambyname('dev').Value := QDevolucionDEV_NUMERO.value;
                dm.Query1.Parameters.parambyname('usu').Value := dm.Usuario;
                dm.Query1.Parameters.parambyname('caj').Value := Cajero;
                dm.Query1.Parameters.parambyname('suc').Value := QDevolucionsuc_codigo.value;
                dm.Query1.ExecSQL;

              end;
            end;
          end;

          //Actualizar NCF Devoluciones (Hecho por Jhonattan Gomez) Sep-2018
          with QUpdDev do begin
          Close;
          Parameters.ParamByName('emp').Value := QDevolucionEMP_CODIGO.Value;
          Parameters.ParamByName('suc').Value := QDevolucionsuc_codigo.Value;
          Parameters.ParamByName('num').Value := QDevolucionDEV_NUMERO.Value;
          Parameters.ParamByName('NCF').Value := DBEdit6.Text;
          ExecSQL;
          end;

          //Actualizar NCF Notas de Credito (Hecho por Jhonattan Gomez) Sep-2018
          with QUpdNC do begin
          Close;
          Parameters.ParamByName('emp').Value := QDevolucionEMP_CODIGO.Value;
          Parameters.ParamByName('suc').Value := QDevolucionsuc_codigo.Value;
          Parameters.ParamByName('num').Value := QDevolucionDEV_NUMERO.Value;
          Parameters.ParamByName('NCF').Value := DBEdit6.Text;
          ExecSQL;
          end;

          if messagedlg('SE HA GENERADO LA DEVOLUCION NUMERO '+inttostr(QDevolucionDEV_NUMERO.value)+
                        ', DESEA IMPRIMIR ESTA DEVOLUCION?',mtconfirmation,[mbyes,mbno],0) = mryes then
          begin
            if dm.QParametrospar_fac_preimpresa.Value = 'False' then
            begin
              if FormatoImp = 2 then
              begin
                application.createform(tRDevolucion, RDevolucion);
                RDevolucion.QDevolucion.Parameters.ParamByName('numero').Value := QDevolucionDEV_NUMERO.value;
                RDevolucion.QDevolucion.Parameters.ParamByName('suc').Value    := QDevolucionsuc_codigo.Value;
                RDevolucion.QDevolucion.open;
                RDevolucion.QDetalle.open;
                {if desem > 0 then
                   RDevolucion.lbComentario.caption := 'SE ENTREGO EL EFECTIVO'
                else
                   RDevolucion.lbComentario.caption := ' ';}

                RDevolucion.PrinterSetup;
                RDevolucion.print;
                RDevolucion.Destroy;
              end
              else if FormatoImp = 3 then
              begin
                Imp40Columnas;
              end;
            end
            else
            begin
              application.createform(tRDevolucionPreImpresa, RDevolucionPreImpresa);
              RDevolucionPreImpresa.QDevolucion.Parameters.ParamByName('numero').Value := QDevolucionDEV_NUMERO.value;
              RDevolucionPreImpresa.QDevolucion.Parameters.ParamByName('suc').Value    := QDevolucionsuc_codigo.Value;
              RDevolucionPreImpresa.QDevolucion.open;
              RDevolucionPreImpresa.QDetalle.open;

              RDevolucionPreImpresa.QRBB.PrinterSetup;
              RDevolucionPreImpresa.QRBB.print;
              RDevolucionPreImpresa.Release;
            end;
          end;

          QDevolucion.Close;
          QDevolucion.Parameters.parambyname('numero').Value := -1;
          QDevolucion.Parameters.parambyname('suc').Value := -1;
          QDevolucion.open;
          QDevolucion.insert;
          PageControl1.ActivePageIndex := 0;
          edTipo.setfocus;
        end;
      end
      else
      begin
        QDevolucion.Post;
        QDevolucion.UpdateBatch;

        Totaliza := False;

        //grabando detalle
        QDetalle.disablecontrols;
        QDetalle.first;
        while not QDetalle.eof do
        begin
          QDetalle.edit;
          QDetalleDEV_NUMERO.value    := QDevolucionDEV_NUMERO.value;
          QDetallesuc_codigo.Value    := QDevolucionsuc_codigo.Value;
          QDetalle.post;
          QDetalle.next;
        end;
        QDetalle.enablecontrols;
        QDetalle.UpdateBatch;

        dm.Query1.close;
        dm.Query1.sql.clear;
        dm.Query1.sql.add('execute pr_graba_dev :emp, :suc, :num, :act, :alm');
        dm.Query1.Parameters.parambyname('emp').Value := dm.QEmpresasEMP_CODIGO.value;
        dm.Query1.Parameters.parambyname('num').Value := QDevolucionDEV_NUMERO.value;
        dm.Query1.Parameters.parambyname('suc').Value := QDevolucionsuc_codigo.value;

        if ACTBalance = True then
           dm.Query1.Parameters.parambyname('act').Value := 'True'
        else
           dm.Query1.Parameters.parambyname('act').Value := 'False';
        dm.Query1.Parameters.parambyname('alm').Value := almacen;
        dm.Query1.ExecSQL;

        if messagedlg('SE HA GENERADO LA DEVOLUCION NUMERO '+inttostr(QDevolucionDEV_NUMERO.value)+
                      ', DESEA IMPRIMIR ESTA DEVOLUCION?',mtconfirmation,[mbyes,mbno],0) = mryes then
        begin
          if dm.QParametrospar_fac_preimpresa.Value = 'False' then
          begin
            if FormatoImp = 2 then
            begin
              application.createform(tRDevolucion, RDevolucion);
              RDevolucion.QDevolucion.Parameters.ParamByName('numero').Value := QDevolucionDEV_NUMERO.value;
              RDevolucion.QDevolucion.Parameters.ParamByName('suc').Value    := QDevolucionsuc_codigo.Value;
              RDevolucion.QDevolucion.open;
              RDevolucion.QDetalle.open;
              {if desem > 0 then
                 RDevolucion.lbComentario.caption := 'SE ENTREGO EL EFECTIVO'
              else
                 RDevolucion.lbComentario.caption := ' ';}

              RDevolucion.PrinterSetup;
              RDevolucion.print;
              RDevolucion.Destroy;
            end
            else if FormatoImp = 3 then
            begin
              Imp40Columnas;
            end;
          end
          else
          begin
            application.createform(tRDevolucionPreImpresa, RDevolucionPreImpresa);
            RDevolucionPreImpresa.QDevolucion.Parameters.ParamByName('numero').Value := QDevolucionDEV_NUMERO.value;
            RDevolucionPreImpresa.QDevolucion.Parameters.ParamByName('suc').Value    := QDevolucionsuc_codigo.Value;
            RDevolucionPreImpresa.QDevolucion.open;
            RDevolucionPreImpresa.QDetalle.open;

            RDevolucionPreImpresa.QRBB.PrinterSetup;
            RDevolucionPreImpresa.QRBB.print;
            RDevolucionPreImpresa.Release;
          end;
        end;

        QDevolucion.Close;
        QDevolucion.Parameters.parambyname('numero').Value := -1;
        QDevolucion.Parameters.parambyname('suc').Value := -1;
        QDevolucion.open;
        QDevolucion.insert;
        PageControl1.ActivePageIndex := 0;
        edTipo.setfocus;

      end;
    end
    else
      Grid.setfocus;
  end;
end;

procedure TfrmDevolucion.QDevolucionBeforePost(DataSet: TDataSet);
begin
  if QDevolucion.State = dsinsert then
  begin
    dm.Query1.close;
    dm.Query1.sql.clear;
    dm.Query1.sql.add('select isnull(max(dev_numero),0) as maximo');
    dm.Query1.sql.add('from devolucion');
    dm.Query1.sql.add('where emp_codigo = :emp');
    dm.Query1.sql.add('and suc_codigo = :suc');
    dm.Query1.Parameters.parambyname('emp').Value := dm.QEmpresasEMP_CODIGO.value;
    dm.Query1.Parameters.parambyname('suc').Value := QDevolucionsuc_codigo.Value;
    dm.Query1.open;
    QDevolucionDEV_NUMERO.value := dm.Query1.fieldbyname('maximo').asinteger + 1;
  end;

  if rgtipo.ItemIndex = 0 then
  begin
    QDevolucionticket_caja.Clear;
    QDevolucionticket_cajero.Clear;
    QDevolucionticket_numero.Clear;
    QDevolucionticket_fecha.Clear;
  end
  else
  begin
    QDevolucionTFA_CODIGO.Clear;
    QDevolucionFAC_FORMA.Clear;
    QDevolucionFAC_NUMERO.Clear;
  end;
  
end;

procedure TfrmDevolucion.btLimpiarClick(Sender: TObject);
begin
  if messagedlg('DESEA CANCELAR LA DEVOLUCION?',mtconfirmation, [mbyes,mbno],0) = mryes then
  begin
    QDevolucion.Close;
    QDevolucion.Parameters.parambyname('numero').Value := -1;
    QDevolucion.Parameters.parambyname('suc').Value := -1;
    QDevolucion.open;
    QDevolucion.insert;
    PageControl1.ActivePageIndex := 0;
    edTipo.setfocus;
  end
  else
    Grid.setfocus;
end;

procedure TfrmDevolucion.FormCreate(Sender: TObject);
var
  a : integer;
begin
  FormatoImp := dm.QParametrosPAR_FORMATODEV.value;

  for a := 0 to (Sender as TForm).ComponentCount -1 DO
  begin
    if Components[a].ClassType = tdbedit then
    begin
      (Components[a] as tdbedit).OnEnter := frmMain.Entra;
      (Components[a] as tdbedit).OnExit := frmMain.sale;
    end;
  end;

  if dm.QParametrosPAR_FACESCALA.Value <> 'True' then
  begin
    Grid.Columns[9].Destroy;
    Grid.Columns[2].Width := Grid.Columns[2].Width + 15;
  end;

  if dm.QParametrosPAR_FACMEDIDA.Value <> 'True' then
  begin
    Grid.Columns[8].Destroy;
    Grid.Columns[2].Width := Grid.Columns[2].Width + 15;
  end;

  if dm.QParametrospar_visualiza_selectivo.Value <> 'True' then
  begin
    Grid.Columns[6].Destroy;
    Grid.Columns[5].Destroy;
    Grid.Columns[2].Width := Grid.Columns[2].Width + 110;
  end;

  if dm.QParametrospar_fac_oferta.Value <> 'True' then
  begin
    Grid.Columns[2].Width := Grid.Columns[2].Width + 15;
    Grid.Columns[1].Destroy;
  end;
end;

procedure TfrmDevolucion.rbFormaClick(Sender: TObject);
begin
  edTipo.SetFocus;
end;

procedure TfrmDevolucion.Imp40Columnas;
var
  s : array [0..20] of char;
  arch, puertopeq : textfile;
  puerto : string;
begin
  if FileExists('puerto.txt') then
  begin
    assignfile(puertopeq, 'puerto.txt');
    reset(puertopeq);
    readln(puertopeq, puerto);
  end
  else
    puerto := 'PRN';

  closefile(puertopeq);
    
  Application.createform(tRDevolucion, RDevolucion);

  AssignFile(arch, 'imp.bat');
  rewrite(arch);
  writeln(arch, 'type t.txt > '+puerto);
  closefile(arch);

  AssignFile(arch, 't.txt');
  rewrite(arch);
  writeln(arch, dm.Centro(trim(dm.QEmpresasEMP_NOMBRE.value)));
  writeln(arch, dm.Centro(trim(DM.QEmpresasEMP_DIRECCION.value)));
  writeln(arch, dm.Centro(trim(DM.QEmpresasEMP_LOCALIDAD.value)));
  writeln(arch, dm.Centro('Telefono : '+trim(dm.QEmpresasEMP_TELEFONO.value)));
  writeln(arch, dm.Centro('RNC: '+dm.QEmpresasEMP_RNC.value));
  writeln(arch, ' ');
  writeln(arch, dm.Centro('D E V O L U C I O N'));
  writeln(arch, ' ');
  writeln(arch, 'Numero  : '+inttostr(QDevolucionDEV_NUMERO.value));
  writeln(arch, 'Cliente : '+tCliente.text);
  writeln(arch, 'Fecha   : '+DateToStr(QDevolucionDEV_FECHA.Value));
  writeln(arch, ' ');
  writeln(arch, 'MONTO   : '+chr(27)+chr(52)+Format('%n',[QdevolucionDEV_TOTAL.value])+chr(27)+chr(53));
  writeln(arch, '----------------------------------------');
  writeln(arch, 'Cant. Descripcion del Producto');
  writeln(arch, '----------------------------------------');
  QDetalle.DisableControls;
  QDetalle.First;
  while not QDetalle.Eof do
  begin
    if QDetalleDEV_CANTIDAD.Value > 0 then
    begin
      s := '';
      fillchar(S, 5-length(floattostr(QDetalleDEV_CANTIDAD.value)),' ');
      writeln(arch, floattostr(QDetalleDEV_CANTIDAD.value)+s+
              copy(trim(QDetallePRO_NOMBRE.value),1,32));
    end;
    QDetalle.Next;
  end;
  QDetalle.EnableControls;
  writeln(arch, ' ');
  writeln(arch, ' ');
  writeln(arch, ' ');
  writeln(arch, dm.Centro('_____________________'));
  writeln(arch, dm.Centro('Realizado por'));
  writeln(arch, ' ');
  writeln(arch, ' ');
  writeln(arch, ' ');
  writeln(arch, dm.Centro('_____________________'));
  writeln(arch, dm.Centro('Autorizado por'));
  writeln(arch, ' ');
  writeln(arch, ' ');
  writeln(arch, ' ');
  writeln(arch, ' ');
  writeln(arch, ' ');
  CloseFile(arch);
  winexec('imp.bat',0);
  RDevolucion.Destroy;
end;

procedure TfrmDevolucion.SpeedButton1Click(Sender: TObject);
begin
  search.AliasFields.clear;
  search.AliasFields.add('Nombre');
  search.AliasFields.add('Código');
  Search.Query.clear;
  Search.Query.add('select usu_nombre, usu_codigo');
  Search.Query.add('from usuarios');
  Search.ResultField := 'usu_Codigo';
  Search.Title := 'Usuarios';
  if Search.execute then
  begin
    edCajero.text := Search.ValueField;
    dm.Query1.close;
    dm.Query1.sql.clear;
    dm.Query1.sql.add('select usu_nombre from usuarios');
    dm.Query1.sql.add('where usu_codigo = :cod');
    dm.Query1.Parameters.parambyname('cod').Value := strtoint(trim(edCajero.text));
    dm.Query1.open;
    if dm.Query1.recordcount = 0 then
      messagedlg('USUARIO NO EXISTE',mterror,[mbok],0)
    else
    begin
      tusuario.text := dm.Query1.fieldbyname('usu_nombre').asstring;
      QDevolucionticket_cajero.Value := StrToInt(edCajero.Text);
    end;
    edCajero.setfocus;
  end;
end;

procedure TfrmDevolucion.edCajeroChange(Sender: TObject);
begin
  if Trim(edCajero.Text) = '' then tusuario.Text := '';
end;

procedure TfrmDevolucion.edCajeroKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if key = vk_return then
  begin
    if Trim(edCajero.text) <> '' then
    begin
      dm.Query1.close;
      dm.Query1.SQL.clear;
      dm.Query1.sql.add('select usu_nombre from usuarios');
      dm.Query1.sql.add('where usu_codigo = :cod');
      dm.Query1.Parameters.parambyname('cod').Value := strtoint(trim(edCajero.text));
      dm.Query1.open;
      if dm.Query1.recordcount = 0 then
        messagedlg('USUARIO NO EXISTE',mterror,[mbok],0)
      else
      begin
        tusuario.text := dm.Query1.fieldbyname('usu_nombre').asstring;
        QDevolucionticket_cajero.Value := StrToInt(edCajero.Text);
      end;
    end;
  end;
end;

procedure TfrmDevolucion.BuscaTicket;
var
  a, caj, tik, usu : integer;
  existe : boolean;
begin
  if rgtipo.ItemIndex = 1 then
  begin
    if (not QDevolucionticket_cajero.IsNull) and
    (not QDevolucionticket_caja.IsNull) and
    (not QDevolucionticket_numero.IsNull) and
    (not QDevolucionticket_fecha.IsNull) then
    begin
      existe := true;
      dm.Query1.close;
      dm.Query1.sql.clear;
      dm.Query1.sql.add('select nombre, status, fecha, total, ncf_fijo, ncf_secuencia, caja, ticket, usu_codigo');
      dm.Query1.sql.add('from montos_ticket');
      dm.Query1.sql.add('where fecha = convert(datetime, :fec, 105)');
      dm.Query1.sql.add('and caja = :caj');
      dm.Query1.sql.add('and usu_codigo = :usu');
      dm.Query1.sql.add('and ticket = :tik');
      dm.Query1.Parameters.parambyname('fec').DataType := ftDate;
      dm.Query1.Parameters.parambyname('fec').Value    := QDevolucionticket_fecha.Value;
      dm.Query1.Parameters.parambyname('caj').Value    := QDevolucionticket_caja.Value;
      dm.Query1.Parameters.parambyname('usu').Value    := QDevolucionticket_cajero.Value;
      dm.Query1.Parameters.parambyname('tik').Value    := QDevolucionticket_numero.Value;
      dm.Query1.open;
      if dm.Query1.recordcount = 0 then
        existe := false
      else
      begin
        caj := dm.Query1.FieldbyName('caja').AsInteger;
        tik := dm.Query1.FieldbyName('ticket').AsInteger;
        usu := dm.Query1.FieldbyName('usu_codigo').AsInteger;
        existe := true;
      end;

      if not existe then
      begin
        dm.Query1.close;
        dm.Query1.sql.clear;
        dm.Query1.sql.add('select nombre, status, fecha, total, ncf_fijo, ncf_secuencia, caja, ticket, usu_codigo');
        dm.Query1.sql.add('from montos_ticket');
        dm.Query1.sql.add('where fecha = convert(datetime, :fec, 105)');
        dm.Query1.sql.add('and caja_original = :caj');
        dm.Query1.sql.add('and usuario_original = :usu');
        dm.Query1.sql.add('and ticket_original = :tik');
        dm.Query1.Parameters.parambyname('fec').DataType := ftDate;
        dm.Query1.Parameters.parambyname('fec').Value    := QDevolucionticket_fecha.Value;
        dm.Query1.Parameters.parambyname('caj').Value    := QDevolucionticket_caja.Value;
        dm.Query1.Parameters.parambyname('usu').Value    := QDevolucionticket_cajero.Value;
        dm.Query1.Parameters.parambyname('tik').Value    := QDevolucionticket_numero.Value;
        dm.Query1.open;
        if dm.Query1.recordcount = 0 then
          existe := false
        else
        begin
          caj := dm.Query1.FieldbyName('caja').AsInteger;
          tik := dm.Query1.FieldbyName('ticket').AsInteger;
          usu := dm.Query1.FieldbyName('usu_codigo').AsInteger;
          existe := true;
        end;
      end;

      if not existe then
      begin
        showmessage('ESTE TICKET NO EXISTE');
        QDevolucionticket_numero.Clear;
        abort;
      end
      else if dm.Query1.fieldbyname('status').asstring = 'ANU' then
      begin
        showmessage('ESTE TICKET ESTA ANULADO');
        QDevolucionticket_numero.Clear;
        abort;
      end
      else if DaysBetween(dm.Query1.fieldbyname('fecha').AsDateTime, Date) >
      dm.QParametrosPAR_DEVDIAS.Value then
      begin
        MessageDlg('ESTE TICKET NO ACEPTA DEVOLUCIONES',mtError,[mbok],0);
        QDevolucionticket_numero.Clear;
        abort;
      end
      else
      begin
        ConItbis  := True;
        QDevolucionDEV_CONITBIS.Value := 'S';
        Almacen   := 1;
        tCliente.text := dm.Query1.fieldbyname('nombre').asstring;
        QdevolucionDEV_NOMBRE.Value := dm.Query1.fieldbyname('nombre').asstring;

        Query1.close;
        Query1.sql.clear;
        Query1.sql.add('select cliente, empresa from formas_pago_ticket');
        Query1.sql.add('where fecha = convert(datetime, :fec, 105)');
        Query1.sql.add('and caja = :caj');
        Query1.sql.add('and usu_codigo = :usu');
        Query1.sql.add('and ticket = :tik');
        Query1.sql.add('and forma = '+QuotedStr('CRE'));
        Query1.Parameters.parambyname('fec').DataType := ftDate;
        Query1.Parameters.parambyname('fec').Value    := QDevolucionticket_fecha.Value;
        Query1.Parameters.parambyname('caj').Value    := caj;
        Query1.Parameters.parambyname('usu').Value    := usu;
        Query1.Parameters.parambyname('tik').Value    := tik;
        Query1.open;

        QDevoluciondev_fecha_factura.Value := dm.Query1.fieldbyname('fecha').Value;
        QDevolucionVEN_CODIGO.Clear;
        QDevolucionCLI_CODIGO.Clear;

        ACTBalance := False;

        if Query1.RecordCount > 0 then
          if not Query1.FieldbyName('cliente').IsNull then
          begin
            QDevolucionCLI_CODIGO.Value := Query1.FieldbyName('cliente').Value;
            ACTBalance := True;
          end;

        if dm.Query1.fieldbyname('ncf_secuencia').AsFloat > 0 then
          QDevolucionNCF.Value := dm.Query1.fieldbyname('ncf_fijo').AsString +
                                  FormatFloat('00000000',dm.Query1.fieldbyname('ncf_secuencia').AsFloat)
        else
          QDevolucionNCF.Clear;

        //Buscando detalle del ticket
        dm.Query1.close;
        dm.Query1.sql.clear;
        dm.Query1.sql.add('select t.secuencia, t.producto, t.descripcion, t.costo, t.precio, t.cantidad, p.pro_itbis, ');
        dm.Query1.sql.add('p.pro_roriginal, p.pro_rfabric, t.devuelta, t.itbis');
        dm.Query1.sql.add('from ticket t, productos p');
        dm.Query1.sql.add('where p.emp_codigo = '+IntToStr(dm.QParametrosPAR_INVEMPRESA.Value));
        dm.Query1.sql.add('and p.pro_codigo = t.producto');
        dm.Query1.sql.add('and t.fecha = convert(datetime, :fec, 105)');
        dm.Query1.sql.add('and t.caja = :caj');
        dm.Query1.sql.add('and t.usu_codigo = :usu');
        dm.Query1.sql.add('and t.ticket = :tik');
        dm.Query1.Parameters.parambyname('fec').DataType := ftDate;
        dm.Query1.Parameters.parambyname('fec').Value    := QDevolucionticket_fecha.Value;
        dm.Query1.Parameters.parambyname('caj').Value    := caj;
        dm.Query1.Parameters.parambyname('usu').Value    := usu;
        dm.Query1.Parameters.parambyname('tik').Value    := tik;
        dm.Query1.open;
        dm.Query1.disablecontrols;

        QDetalle.close;
        QDetalle.open;
        a := 0;
        Insertar := True;
        while not dm.Query1.eof do
        begin
          a := a + 1;
          QDetalle.append;
          QDetalleDET_SECUENCIA.value     := dm.Query1.fieldbyname('secuencia').asinteger;
          QDetalleDET_ESCALA.Value        := 'False';
          QDetalleDET_COMISION.Value      := 0;
          QDetallePRO_SERVICIO.Value      := 'False';
          QDetalleEMP_CODIGO.value        := dm.QEmpresasEMP_CODIGO.value;
          QDetallePRO_CODIGO.value        := dm.Query1.fieldbyname('producto').asinteger;
          QDetalleDEV_COSTO.value         := dm.Query1.fieldbyname('costo').asfloat;
          QDetalleDEV_PRECIO.value        := dm.Query1.fieldbyname('precio').AsFloat;
          QDetalleDEV_TOPECANTIDAD.value  := dm.Query1.fieldbyname('cantidad').asfloat -
                                             dm.Query1.fieldbyname('devuelta').asfloat;
          QDetalleDEV_CONITBIS.value      := dm.Query1.fieldbyname('pro_itbis').asstring;
          QDetalleDEV_DESCUENTO.value     := 0;
          QDetalleDEV_ITBIS.Value         := dm.Query1.fieldbyname('itbis').asfloat;

          if QDetalleDEV_ITBIS.Value > 0 then
            QDetalleDEV_CONITBIS.Value := 'S'
          else
            QDetalleDEV_CONITBIS.Value := 'N';
          
          {if dm.Query1.fieldbyname('pro_itbis').asstring = 'S' then
            QDetalleDEV_ITBIS.value       := ((dm.Query1.fieldbyname('precio').asfloat *
                                             dm.Query1.fieldbyname('cantidad').asfloat) *
                                             QDetalleDEV_ITBIS.Value)/100;}
                                             
          QDetalleDEV_CANTFACTURADA.value := dm.Query1.fieldbyname('cantidad').asfloat;
          QDetallePRO_NOMBRE.value        := dm.Query1.fieldbyname('descripcion').asstring;
          QDetallePRO_RORIGINAL.value     := dm.Query1.fieldbyname('pro_roriginal').asstring;
          QDetallePRO_RFABRIC.value       := dm.Query1.fieldbyname('pro_rfabric').asstring;
          QDetalleDET_MEDIDA.Value        := 'Und';
          QDetalledet_cant_oferta.Value   := 0;
          QDetalledet_selectivo_ad.Value  := 0;
          QDetalledet_selectivo_con.Value := 0;
          QDetalle.post;
          dm.Query1.next;
        end;
        dm.Query1.enablecontrols;
        QDetalle.first;
        Insertar := False;
      end;
    end;
  end;
end;

procedure TfrmDevolucion.QDevolucionticket_cajaChange(Sender: TField);
begin
  if not QDevolucionticket_caja.IsNull then BuscaTicket;
end;

procedure TfrmDevolucion.QDevolucionticket_cajeroChange(Sender: TField);
begin
  if not QDevolucionticket_cajero.IsNull then BuscaTicket;
end;

procedure TfrmDevolucion.QDevolucionticket_numeroChange(Sender: TField);
begin
  if not QDevolucionticket_numero.IsNull then BuscaTicket;
end;

procedure TfrmDevolucion.QDevolucionticket_fechaChange(Sender: TField);
begin
  if not QDevolucionticket_fecha.IsNull then BuscaTicket;
end;

procedure TfrmDevolucion.rgtipoClick(Sender: TObject);
begin
  PageControl1.ActivePageIndex := rgtipo.ItemIndex;
end;

procedure TfrmDevolucion.btmotivoClick(Sender: TObject);
begin
  search.Query.clear;
  search.AliasFields.clear;
  search.Query.add('select mot_nombre, mot_codigo');
  search.Query.add('from Motivo_Devolucion');
  search.Query.add('where emp_codigo = '+inttostr(dm.QEmpresasEMP_CODIGO.value));
  search.AliasFields.add('Nombre');
  search.AliasFields.add('Código');
  search.ResultField := 'mot_codigo';
  search.Title := 'Motivos de Devolucion';
  if search.execute then
  begin
    QDevolucionmot_codigo.Value := StrToInt(search.valuefield);
    DBEdit13.SetFocus;
  end;
end;

procedure TfrmDevolucion.QDevolucionmot_codigoGetText(Sender: TField;
  var Text: String; DisplayText: Boolean);
begin
  if not QDevolucionmot_codigo.IsNull then
  begin
    Text := IntToStr(QDevolucionmot_codigo.Value);
    dm.Query1.Close;
    dm.Query1.SQL.Clear;
    dm.Query1.SQL.Add('select mot_nombre from Motivo_Devolucion');
    dm.Query1.SQL.Add('where emp_codigo = :emp and mot_codigo = :cod');
    dm.Query1.Parameters.ParamByName('emp').Value := dm.QEmpresasEMP_CODIGO.Value;
    dm.Query1.Parameters.ParamByName('cod').Value := QDevolucionmot_codigo.Value;
    dm.Query1.Open;
    if dm.Query1.RecordCount > 0 then
      tmotivo.Text := dm.Query1.FieldByName('mot_nombre').AsString
    else
      tmotivo.Text := '';
  end;
end;

end.
